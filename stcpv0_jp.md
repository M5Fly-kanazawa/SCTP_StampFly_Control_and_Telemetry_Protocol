# StampFly Telemetry & Control Protocol (STCP) v0.2

StampFly 用に設計された軽量リアルタイム通信プロトコルです。**テレメトリ**と**操縦コマンド**を一つの共通仕様で扱えることを目的としています。WebSocket, UDP, ESP-NOW, BLE(GATT通知) などの多様なトランスポートに対応します。

> 適用範囲：機体上のフレーム構造およびPCブリッジでの取り扱い。目標は、姿勢テレメトリ 50–200 Hz、スロー系テレメトリ 5–20 Hz、コマンド 50–500 Hz。

---

## 0. 設計目標

* **トランスポート非依存**：異なる物理層でも同一フレームを利用。
* **軽量**：12Bショートヘッダと短い固定ペイロード。
* **時間管理**：シーケンス番号 + 時刻差分で遅延・欠落を把握。
* **拡張性**：TLVやCBORで柔軟に拡張可能。
* **信頼性**：ACK/NACKは必要に応じて、損失の多いリンクでは有効化。
* **セキュリティ**：HMACや暗号化のフックを定義。
* **統合**：テレメトリと操縦コマンドを統一仕様で扱う。

---

## 1. レイヤリングとトランスポート

```
+------------------+   +------------------+   +------------------+
| Application      |   | Application      |   | Application      |
| (STCP Frames)    |   | (STCP Frames)    |   | (STCP Frames)    |
+------------------+   +------------------+   +------------------+
        |                    |                      |
   WebSocket(TCP)         UDP/IP               ESP-NOW / BLE
```

* トランスポートごとにフレーミング方法は異なるが、STCPフレームの内容は同一。
* ESP-NOWでは1 MACフレームに1 STCPフレームを格納。

---

## 2. フレーム概要

* 各STCPフレーム = ヘッダ + ペイロード + (任意のTLV)。
* ヘッダはショート(12B)または拡張(TLV)。

---

## 3. メッセージ種別

| Type | 名称           | 向き    | 周期       | ペイロード           |
| ---: | ------------ | ----- | -------- | --------------- |
|    0 | HELLO        | 双方向   | 接続時      | 機能・UID          |
|    1 | PONG         | 応答    | 随時       | RTT情報           |
|    2 | ATT\_FAST    | 機体→地上 | 50–200Hz | 姿勢(Quat,pqr,高度) |
|    3 | TEL\_SLOW    | 機体→地上 | 5–20Hz   | CBOR地図          |
|    4 | EVENT        | 機体→地上 | 不定期      | CBORイベント        |
|    5 | PARAM\_GET   | 地上→機体 | 要求       | CBORキー          |
|    6 | PARAM\_VALUE | 機体→地上 | 応答       | CBORマップ         |
|    7 | PARAM\_SET   | 地上→機体 | 指令       | CBORマップ         |
|    8 | CMD\_HIGH    | 地上→機体 | 不定期      | 高レベルコマンド        |
|    9 | ACK/NACK     | 双方向   | 随時       | seqとコード         |
|   10 | PING         | 地上→機体 | 随時       | ホスト時刻           |
|   11 | TIMESYNC     | 双方向   | 1–2Hz    | 同期TLV           |
|   12 | LOG\_CHUNK   | 機体→地上 | 随時       | ログ断片            |
|   13 | FILE\_XFER   | 双方向   | 随時       | ファイル断片          |
|   14 | CMD\_RC      | 地上→機体 | 50–500Hz | RC型コマンド         |

---

## 4. ペイロード定義

### 4.1 ATT\_FAST (28B)

姿勢クォータニオン4要素 + 角速度3要素 + 高度1要素。

### 4.2 TEL\_SLOW

CBOR形式。例: `batt`, `mode`, `mot`, `cpu`。

### 4.3 CMD\_HIGH

CBORコマンド例: `{ "name":"takeoff", "alt":1.0 }`

### 4.4 CMD\_RC (16B)

```
struct CmdRC {
  int16_t roll;
  int16_t pitch;
  int16_t yaw;
  int16_t thrust;
  uint16_t aux;   // フライトモードやスイッチ
  uint16_t rsv;
}
```

* 短く固定長。ESP-NOWやBLEに適合。
* 高速周期(50–500Hz)で送信。

---

## 5. 信頼性・優先度・セキュリティ

* **優先度**：CMD > PARAM/ACK > ATT\_FAST > TEL\_SLOW。
* **ACK/NACK**：制御系(CMD, PARAM)のみ必須。テレメは不要。
* **暗号化**：Flags.Cで有効化。ChaCha20などを想定。
* **デッドマン**：一定時間CMD\_RCが来なければフェイルセーフ動作。

---

## 6. バージョン交渉

* HELLOで機能・MTU・CMD\_RC対応有無を通知。
* 未対応ならCMD\_HIGHへフォールバック。

---

## 7. PCブリッジでの扱い

* JSONに変換してWebブラウザへ配信。

```json
{
  "src_id":1,
  "type":"ATT_FAST",
  "quat":[...],
  "omega":[...],
  "alt":1.23
}
```

* ログ保存はParquet形式を推奨。

---

## 8. まとめ

* CMD\_RC: RCスティック相当の低レイテンシ指令。
* CMD\_HIGH: 高レベル制御コマンド。
* 両者を統合的に扱う軽量プロトコル。

---

## 9. C/Python テンプレート

* C (ESP-IDF) ヘッダ/送信コード例。
* Python デコーダ例。

---

## 10. ライセンスとIPR

本仕様はStampFlyプロジェクト向けに独自に設計されたものです。既存プロトコル（CRTP, SBUS, MAVLinkなど）のコピーではありません。

### ライセンス

MIT License として公開します。商用・学術問わず自由に利用・改変・再配布可能です。
